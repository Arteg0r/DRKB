#spec #event 


## Введение

Результатом развития Отношений между парами Героев в Отряде являются Боевые эффекты, возникающие в ходе Боя. Они могут быть как положительными, увеличивающими боевую мощь Отряда, так и отрицательными, мешающими Отряду действовать в Бою эффективно. 

Данная механика вносит элемент непредсказуемости в путешествия, "оживляет" Героев, а также заставляет игрока искать компромиссы при подборе членов Отряда. Ему предстоит делать выбор: собрать разношерстный и полный возможностей Отряд и рискнуть получить серьезные конфликты, либо собрать более ладящих между собой Героев, но не получить все богатство возможностей. 

Игроку важно следить за развитием Отношений внутри отряда, хотя он имеет ограниченные возможности влиять на них (возможно через POI).


## Глоссарий ТЗ

Активный герой - Герой, атакующий противника или защищающийся от атаки противника. 

Напарник - Герой, накладывающий эффект на активного Героев согласно рубежу Отношений. Отправитель эффекта.

Рубежи Отношений - значения на шкале отношений, определяющие статус между парой Героев и связанные с ним эффекты в бою. 


## Компоненты

- Таблица эффектов от рубежей и фазы (защита или атака)
- Таблица шансов эффектов
- HUD компоненты - отображение имени/пиктограммы эффекта со значением + портрета отправителя эффекта около спрайта существа
- Правила возникновения боевых эффектов


## Шкала отношений

Шкала отношений может принимать значения от -30 до 30. Она имеет несколько рубежей: вражда (-30), неприязнь (-15), симпатия (15), дружба (30). 

Рубеж между каждой парой Героев определяет, какие события могут возникнуть между ними в процессе Боя. Полный список эффектов в зависимости от рубежа описан на этом листе.


## Типы боевых эффектов

Существует 6 типов боевых эффектов, три из которых временно меняют значение хар-к Героя:

**SpecMaxMin** - отлючает рандомный разброс урона, фиксирует значение урона по минимальной или максимальной границе. 

**SpecAbs** - изменяет хар-ку на целое число или процентный пункт (если хар-ка указана в процентах)

**SpecPercent** - изменяет хар-ку на заданный процент.

У 3 остальных предусмотрен иной алгоритм работы.

#### AlgoRevenge

Эффект случается только в фазе защиты.

После того, как защищающийся Герой был атакован врагом, его напарник (который стал участником эффекта) немедленно атакует данного врага (мстит за приятеля).

Получается, что напарник получает дополнительный ход, вне зависимости от того, совершал ли он атаку в этот раунд или нет. Он просто встает первым в очередь, двигая и своих, и чужих. 

Эффект указывается двумя пиктограммами. Кастующий получает пиктограмму + портрет напарника, ради которого он вступил в бой. Враг, атаковавший напарника, получает пиктограмму цели. 

#### AlgoTarget

Эффект случается только в фазе защиты.

После того, как защищающийся Герой был атакован врагом, его напарник (который стал участником эффекта) отмечает данного врага специальной меткой. 

С этого момента и до момента исчезновения метки все Герои отряда во время своих ходов атакуют только данного врага.

Метка действует некоторое время (длительность жизни задается через конфиг). Если в процессе жизни этой метки выпала следующая метка этого же типа, то предыдущая метка сразу пропадает.

#### AlgoDamageTypeBlock 

Эффект случается только в фазе защиты.

У каждого существа есть тип урона - силовой, колющий и т.п. Для данного боевого эффекта вводим механику невосприимчивости к определенному типу урону.

Когда защищающийся Герой стал целью одного из врагов, его напарник (который стал участником эффекта) немедленно, *перед атакой врага*, накладывает на него эффект невосприимчивости к определенному типу урона (сейчас накладывает тот тип невосприимчивости, носителем которого он сам является, но в будущем - необязательно).

Если у врага оказался другой типу урона, то он атакует Героя как обычно. Если неуязвимость и тип урона совпали, атака не наносит урона (по аналогии с dodged!). Нужно выводить надпись по аналогии с dodged!, например Resisted!, чтобы сообщать, когда эффект сработал.

Неязвимость действует некоторое время. Неуязвимости могут накладываться друг на друга: одинаковые складывают время своего действия, новые возникают параллельно и существуют со собственным счетчиком длительности.


## Правила возникновения эффектов во время боя

- Каждая пара Героев генерирует эффекты независимо между других пар, исходя из достигнутых рубежей в своей шкале Отношений.
- Подходящий эффект однозначно определяется рубежом и ситуацией Героя - атака или защита (см [таблицу](https://docs.google.com/spreadsheets/d/12acMQ8UTlDRHP0NvzSGVLYKb9QMhw2AjD9EKXTQug3U/edit#gid=555667875))
- Активный герой (атакующий или защищающийся) может получить за один ход (или находясь в "защите") до 3 эффектов - за каждую шкалу отношений с другим компаньоном в отряде из 4 Героев.
- Вероятность возникновения эффекта в каждой паре Героев регулируется числом возникших ранее эффектов:

Кол-во эффектов | Шанс
---|---
0 | 25%
1 | 15%
2| 5%
3|0%
4|0%

- Активный Герой, находясь в атаке или защите, проверят свои отношения с 3 остальными Героями по таблице шансов, сработавшие эффекты немедленно накладываются на активного Героя или его противника (кроме AlgoRevenge и AlgoTarget)
- После боя счетчик шансов обнуляется.
- Если напарник находится под действием эффекта Заморозки и Оглушения и должен был атаковать, шанс возникновения эффекта не проверяется
- Если активный герой защищается и находится под действием Заморозки и Оглушения, то напарник проверяет шанс и накладывает эффекты, если они выпали.
- Если игрок получает противоположный боевой эффект к тому, что уже есть на нем, то предыдущий эффект немедленно прекращается, возникает новый. Пример: если был минимальный урон, сверху получен максимальный - первый перестает действовать сразу, вне зависимости, сколько времени должен был действовать. Пример 2: понизить уклонение на 20 пп, следом повысить на 20 пп - то повышаем не от старого значения, а от базового, предыдущий эффект полностью снимаем.

## Отображение эффектов на Герое или противнике

В текущий момент на Герое и противниках отображаются бонусы от типа урона - в виде анимированной пиктограммы поверх спрайта противника (горение, заморозка). Для отображения боевых эффектов мы будем придерживаться следующих правил:

- Должны быть рядом со спрайтом Героя/Противника
- Эффекты отображаются как на Героях, так и Противниках
- Не должны мешать отображению Бонусов от типа урона
- Хотим связать боевой эффект с напарником, отправителем Эффекта 
- Помнить, что Эффектов может быть много - не только с текущего раунда, но и активных с другого раунда
- Число отображения урон от атаки под действием эффекта нужно раскрашивать - зеленым в случае усиленного дамага, красным - пониженного
- Если действуем иммунность для какого-то типа урона, нужно отображаться надпись -Immunity! (по аналогии с Crit и Dodged)

Для первой версии я предлагаю отображать Эффекты над спрайтом существа или позади (у задней стороны спрайта). Обязательно показывать связку: портрет Героя + название эффекта или, если это изменение хар-ки, ее название и изменение. Сейчас можно использовать названия переменных из кода с измененным в ходе Эффекта значением, чтобы сейчас не думать про подходящие пиктограммы.

Отдельные разъясения по отображению для следующих эффектов:

AlgoDamageTypeBlock - эффект отображается на Герое, убирается после истечения срока активности. Отображается портрет напарника и название эффекта, причем нужно отображать в названии конкретную неуязвимость (InvFireDam...)

