#spec #enemies 

## Введение

В этом документе описан функционал формирования и отображения Отрядов Врагов. Документ решает следующие задачи:
- В ходе спавна формируются сбалансированные Отряды - для исключения крайних случаев, когда спавнятся слишком сильные или слишком слабые Отряды.
- Спавнятся Отряды Врагов более разнообразные по силе - так Отряд Героев на разных стадиях прокачки сможет выбирать соответствующие свой силе бои.
- Отряды Врагов состоят из существ разных типов - сражения должны стать более интересными и разнообразными.


## Компоненты

- Новое правило: для спавна Отрядов Врагов используем только существ с флагом "E"
- Алгоритм подготовки Отрядов Врагов для Рейда (Экспедиции)
- Средства индикации содержимого Отряда Врагов на Карте Мира


## Сила существа и Отряда Врагов

Для удобства вводим уровень силы существ. В данный момент сила назначается вручную, на глаз, так, чтобы сбалансировать "вес" существа при его спавне в отряде:

Уровень силы |Существо | Цвет фона на портрете | Базовая Редкость
---- | ------ |  ----- | ---
1| Centaur, Skeleton, Mummy | Голубой | 45%
2| Vampire, Lich| Синий | 30%
7| Cyclop| Фиолетовый | 15%
10| Titan, Black_Dragon | Оранжевый | 10%

Если нам нужно посчитать общую силу Отряда, складываем уровни сил его членов. Например, если в отряде два Скелета, один Лич и один Дракон, то суммарная сила Отряда равна: 2 х 1 + 2 + 10 = 14.

Редкость показывает, насколько часто существо может появиться внутри отряда. Об этом показателе будет рассказано ниже.


## Количество отрядов

Общее количество Гексов для спавна на игровом поле размером 50 x 50 - чуть менее 2000 (вычитаем 500 Гексов Лавы и около 20 POI).

Отрядами Врагов мы хотим занять 1-2% Гексов, что при вышеуказанном размере поля составляет примерно 20-40 отрядов. Точное количество отрядов для Рейда (Экспедиции) определяется случайным образом в вышеуказанном диапазоне: 1-2%.


## Сила отрядов

После того как мы определили точное кол-во Отрядов для спавна, мы должны наполнить их существами. При этом мы хотим, чтобы на Карте Мира были Отряды разной силы: чтобы игрок мог начать со слабых, обходя средних и сильных, а прокачавшись вернуться к ним (либо осознанно рискнуть и попытаться победить более сильный отряд).

Диапазон суммарной силы отряда | Доля спавна 
--- | ---
1 - 5 (здесь и ниже - выбрано случайно) | 30%
6 - 10 | 40%
11 - 15 | 15%
16 - 20 | 10%
21 - 30 | 5%

Пример: допустим, всего имеем 20 Отрядов на Карте, 40% - это 8 Отрядов, эти 8 Отрядов не будут выходить за рамки силы 6-10: 6, 7, 7, 9, 10, 10, 10, 10

## Существа в Отрядах

После того, как мы определили количество Отрядов и назначили каждому из них суммарную силу, настало время наполнить каждый Отряд существами.

Чтобы определить, какие существа появятся в Отряде:

- Смотрим силу Отряда - это предел наполнения существами по силе, при его пересечении набор в Отряд заканчивается.
- Если сила отряда меньше самого сильного существа, то оно в отряде не появляется. Пример: Отряд с суммарной силой 7 не может включать Дракона (у него сила 10). 
- Когда какие-то существа исключаются из набора (см. пример с Драконом выше), нам нужно перераспределить Редкость (см. [[#Сила существа и Отряда Врагов]]). Пример: в Отряде с силой 5 не могут участвовать существа 7 и 10, значит новая редкость существ силы 1 и 2 становятся: 45/75 и 30/75
- Чем больше сила Отряда, тем меньше редкость сильных существ - например, в мощных отрядах вероятность возникновения Дракона выше:

Изменение от базовой редкости в зависимости от силы отряда:

Диапазон суммарной силы отряда  | 1 сущ | 2 сущ | 7 сущ | 10 сущ 
--- | --- | --- | --- | ---
1 - 10  | 0 | 0 | 0 | 0
11 - 20 | -20% | -15%| +20%| +15%
21 - 30 | -30% | -20% | +20%| +30%

- Далее начинаем наполнять ячейки отряда (всего 8).
- Проверяем возможность появления первого существа согласно базовым или пересчитанным редкостям. Отряды с равной силой имеют равный шанс появления. Пример: если нужно вызвать существо с силой 1, то у Centaur, Skeleton, Mummy равный шанс появления
- После спавна существа проверяем, не вышли ли мы из диапазона суммарной силы Отряда
- Если нет - вызываем следующее существо согласно актуальной редкости, затем проверяем диапазон
- Продолжаем до тех пор, пока не закончатся ячейки или не будет превышена сила отряда

При наполнении Отряда допустимы недовес (закончились ячейки, спавнить некуда), и перевес (заспавнили слишком мощное существо) по силе. Считаем, что такая погрешность добавляет разнообразие.


## Выбор линии атаки существ Отряда

Существа руководствуются общим правилом - дистанты назад, ближники - вперед. Если не хватает нужных ячеек, существа спавнятся в свободные ячейки. Если есть только дистанты или только ближники, первые тяготеют к арьергарду, вторые - к авангарду.


## Отображение отряда на Карте мира

В качестве спрайта Отряда берется спрайт существа с максимальным уровнем силы, согласно таблице выше.

Рядом со спрайтом отряда рисуем число, равное суммарной силе Отряда, на которое будет ориентироваться плейтестер.