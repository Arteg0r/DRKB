#spec #enemies 

## Введение

В этом документе описан функционал формирования и отображения Отрядов врагов. Направлен решает следующие задачи:
- В ходе спавна формируются сбалансированные отряды - для исключения крайних случаев, когда спавнятся слишком сильные или слишком слабые отряды.
- Спавнятся Отряды врагов разной мощности, которые предназначены для ранних боев (когда отряд героев слаб) и финальных боев (когда отряд прокачался) 
- Отряды состоят из существ разных типов - сражения более интересные и разнообразные, сбалансированные за счет разных существ.


## Компоненты

- Новое правило: для спавна Отрядов Врагов используем только существ с флагом E
- Алгоритм подготовки Отрядов врагов для Экспедиции
- Средства отображения содержимого Отряда на Карте


## Сила существа и Отряда врагов

Для удобства вводим уровень силы существ. В данный момент сила назначается вручную, на глаз, так, чтобы сбалансировать "вес" существа при его спавне в отряде:

Уровень силы |Существо | Цвет фона на портрете | Базовая Редкость
---- | ------ |  ----- | ---
1| Centaur, Skeleton, Mummy | Голубой | 45%
2| Vampire, Lich| Синий | 30%
7| Cyclop| Фиолетовый | 15%
10| Titan, Black_Dragon | Оранжевый | 10%

Если нам нужно посчитать общую силу отряда, складывает уровни сил его членов. Например, если в отряде два Скелета, один Лич и один Дракон, то суммарная сила Отряда равна: 2 х 1 + 2 + 10 = 14.

Редкость показывает, насколько часто существо может появиться внутри отряда. Об этом показателе будет рассказано ниже.


## Количество отрядов

Общее количество клеток для спавна для игрового поля 50 x 50 - чуть менее 2000 (минус 500 Гексов Лавы и около 20 - POI).

Отрядами Врагов мы хотим занять 1-2% Гексов, что при вышеуказанном размере поля составляет примерно 20-40 отрядов. Точное количество отрядов для Рейда (Экспедиции) определяется случайным образом в вышеуказанном диапазоне 1-2%.


## Сила отрядов

После того как мы определили точное кол-во отрядов для спавна, мы должны наполнить их существами. При этом мы хотим, чтобы на поле были Отряды разной силы: чтобы игрок мог начать со слабых, обходя средних и сильных, а прокачавшись вернуться к ним.

Диапазон суммарной силы отряда | Доля спавна 
--- | ---
1 - 5 (здесь и ниже - выбрано случайно) | 30%
5 - 10 | 40%
10 - 15 | 15%
15 - 20 | 10%
20 - 30 | 5%


## Существа в отрядах

После того, как мы определили набор Отрядов для рейда, настало время наполнить их существами. Для этого еще раз обратимся к таблице в разделе [[#Сила отрядов]].

Чтобы определить, какие существа появятся в отряде:

- Смотрим силу отряда - это предел наполнения существами по силе, при его пересечении набор в отряд заканчивается
- Если сила отряда меньше самого сильного существа, то оно в отряде не появляется. Пример: отряд с силой 7 не может включать Дракона (у него сила 10). 
- Если какие-то существа исключаются, нам нужно перераспределить Редкость. Пример: в отряде с силой 5 не могут участвовать существа 7 и 10, значит новая редкость существ силы 1 и 2 становятся: 45/75 и 30/75
- Чем больше сила отряда, уменьшается редкость - например, в мощных отрядах вероятность возникновения Дракона выше

Изменение от базовой редкости в зависимости от силы отряда:

Диапазон суммарной силы отряда  | 1 сущ | 2 сущ | 7 сущ | 10 сущ 
--- | --- | --- | --- | ---
1 - 10  | 0 | 0 | 0 | 0
10 - 20 | -20% | -15%| +20%| +15%
20 - 30 | -30% | -20% | +20%| +30%

- Далее начинаем наполнять ячейки отряда (всего 8).
- Проверяем возможность появления первого существа согласно базовым или пересчитанным редкостям
- Проверяем, не вышли мы из диапазона суммарной силы Отряда
- Если нет - вызываем следующее существо согласно актуальной редкости, проверяем диапазон
- Продолжаем до тех пор, пока не закончатся ячейки или не будет превышена сила отряда

При наполнении отряда допустимы недовес (закончились ячейки, спавнить некуда), и перевес (заспавнили слишком мощное существо) по силе. 

## Выбор линии атаки существ Отряда

Существа руководствуются общим правилом - дистанты назад, ближники - вперед. Если не хватает нужны ячеек, спавняться просто в свободные. Если есть только дистанты или только ближники, первые тяготеют к арьергарду, вторые - к авангарду

## Отображение отряда на Карте мира

В качестве спрайта Отряда берется спрайт существа с максимальным уровнем силы.

Рядом со спрайтом отряда рисуем число, равное суммарной силе Отряда, на которое будет ориентироваться  плейтестер.